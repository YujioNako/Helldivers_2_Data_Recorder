<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helldivers 2 æˆ˜äº‰ç›‘æ§ä»ªè¡¨ç›˜</title>
    <script src="/src/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #ffdd44;
            margin: 0;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .subtitle {
            color: #aaa;
            margin-top: 10px;
            font-size: 1.1rem;
        }
        
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 5px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #ffffff;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .nav-tab.active {
            background-color: #ffdd44;
            color: #1a1a2e;
            font-weight: bold;
        }
        
        .nav-tab:hover:not(.active) {
            background-color: #3a3a3a;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #333 0%, #444 100%);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid #ffdd44;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(255, 221, 68, 0.2);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ffdd44;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .chart-container {
            background: linear-gradient(135deg, #2a2a2a 0%, #333 100%);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
        }
        
        .chart-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ffdd44;
            text-align: center;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .planets-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .planets-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            min-height: 600px;
        }
        
        .planets-sidebar {
            background: linear-gradient(135deg, #2a2a2a 0%, #333 100%);
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
            max-height: 80vh;
        }
        
        .planets-main {
            background: linear-gradient(135deg, #2a2a2a 0%, #333 100%);
            border-radius: 12px;
            padding: 20px;
        }
        
        .sector-group {
            margin-bottom: 20px;
        }
        
        .sector-header {
            font-size: 1.1rem;
            font-weight: bold;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            text-align: center;
            background-color: #555;
            color: white;
        }
        
        .planet-item {
            background-color: #3a3a3a;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid;
            position: relative;
        }
        
        .planet-item.owner-1 {
            border-left-color: #4CAF50;
        }
        
        .planet-item.owner-2 {
            border-left-color: #8BC34A;
        }
        
        .planet-item.owner-3 {
            border-left-color: #FF9800;
        }
        
        .planet-item.owner-4 {
            border-left-color: #9C27B0;
        }
        
        .planet-item:hover {
            background-color: #4a4a4a;
            transform: translateX(-5px);
        }
        
        .planet-item.selected {
            transform: translateX(-5px) scale(1.05);
            background-color: #555555;
        }
        
        .planet-item.critical {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 67, 54, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 67, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 67, 54, 0); }
        }
        
        .planet-name {
            font-weight: bold;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .planet-owner-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .planet-owner-indicator.owner-1 { background-color: #4CAF50; }
        .planet-owner-indicator.owner-2 { background-color: #8BC34A; }
        .planet-owner-indicator.owner-3 { background-color: #FF9800; }
        .planet-owner-indicator.owner-4 { background-color: #9C27B0; }
        
        .planet-status-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .planet-status-indicator.critical { background-color: #f44336; }
        .planet-status-indicator.gaining { background-color: #2196f3; }
        .planet-status-indicator.losing { background-color: #f44336; }
        .planet-status-indicator.stable { background-color: #4CAF50; }
        .planet-status-indicator.enemy-controlled { background-color: #9E9E9E; }
        .planet-status-indicator.losing { background-color: #f3e721; }
        .planet-status-indicator.under-fierce-attack { background-color: #ff9800; }
        .planet-status-indicator.contested { background-color: #ffdd44; }
        
        .planet-info {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .planet-trend {
            font-size: 0.75rem;
            margin-top: 4px;
        }
        
        .trend-positive { color: #4CAF50; }
        .trend-negative { color: #f44336; }
        .trend-neutral { color: #ffdd44; }
        .trend-enemy { color: #9E9E9E; }
        
        .planet-details {
            text-align: center;
        }
        
        .planet-details h3 {
            color: #ffdd44;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .planet-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .planet-stat {
            background-color: #3a3a3a;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        
        .planet-stat.critical {
            background-color: #4a2c2c!important;
            border-left: 3px solid #f44336!important;
        }
        
        .planet-stat.positive {
            background-color: #2c4a2c!important;
            border-left: 3px solid #4CAF50!important;
        }
        
        .planet-stat.enemy {
            background-color: #3a3a3a!important;
            border-left: 3px solid #9E9E9E!important;
        }
        
        .regions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .region-card {
            background-color: #3a3a3a;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #666;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .region-card:hover {
            background-color: #4a4a4a;
            transform: translateY(-2px);
        }
        
        .region-card.selected {
            transform: translateY(-2px) scale(1.05);
            background-color: #555555;
        }
        
        .region-card.owner-1 { border-left-color: #4CAF50; }
        .region-card.owner-2 { border-left-color: #8BC34A; }
        .region-card.owner-3 { border-left-color: #FF9800; }
        .region-card.owner-4 { border-left-color: #9C27B0; }
        
        .region-card.enemy-controlled {
            /*border-left-color: #9E9E9E;
            background-color: #2a2a2a;*/
        }
        
        .region-card.under-attack {
            /*animation: pulse 1.5s infinite;*/
        } 

        .region-card.under-fierce-attack {
            animation: pulse 1.2s infinite;
            /*border-left-color: #ff9800 !important;*/
        }
        
        .region-card.critical { 
            animation: pulse 0.6s infinite;
        }
        
        .region-card.losing {
            /*border-left-color: #ffdd44 !important;*/
        }
        
        .region-status.under-fierce-attack {
            background-color: #ff9800;
            animation: blink 1.2s infinite;
        }
        
        .region-status.losing {
            background-color: #ffdd44;
            color: #000;
        }
        
        .region-header {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .region-status {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 4px;
            background-color: #666;
        }
        
        .region-status.critical { background-color: #f44336; animation: blink 1s infinite; }
        .region-status.gaining { background-color: #2196f3; }
        .region-status.losing { background-color: #f44336; }
        .region-status.stable { background-color: #4CAF50; }
        .region-status.enemy-controlled { background-color: #9E9E9E; color: #000; }
        .region-status.losing { background-color: #f3e721; }
        .region-status.under-fierce-attack { background-color: #ff9800; }
        .region-status.available { background-color: #ffdd44; }
        .region-status.contested { background-color: #ffdd44; }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }
        
        .health-bar {
            width: 100%;
            height: 8px;
            background-color: #555;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444 0%, #ffaa00 50%, #4CAF50 100%);
            transition: width 0.3s ease;
        }
        
        .health-fill.enemy {
            background: linear-gradient(90deg, #9E9E9E 0%, #757575 100%);
        }
        
        .region-metrics {
            font-size: 0.85rem;
            margin-top: 8px;
        }
        
        .region-metrics .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .metric-value.positive { color: #4CAF50; }
        .metric-value.negative { color: #f44336; }
        .metric-value.neutral { color: #ffdd44; }
        .metric-value.enemy { color: #9E9E9E; }
        
        .region-charts {
            margin-top: 20px;
            display: none;
        }
        
        .region-charts.active {
            display: block;
        }
        
        /* è®¢å•æ¨¡å—æ ·å¼ */
        .orders-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .orders-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            min-height: 600px;
            margin-bottom: 30px;
        }

        .orders-sidebar {
            background: linear-gradient(135deg, #2a2a2a 0%, #333 100%);
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
            max-height: 80vh;
        }

        .orders-main {
            background: linear-gradient(135deg, #2a2a2a 0%, #333 100%);
            border-radius: 12px;
            padding: 20px;
            min-height: 500px;
        }

        .order-item {
            background-color: #3a3a3a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #ffdd44;
            position: relative;
        }

        .order-item:hover {
            background-color: #4a4a4a;
            transform: translateX(5px);
        }

        .order-item.selected {
            background-color: #ffdd44;
            color: #1a1a2e;
            box-shadow: 0 4px 8px rgba(255, 221, 68, 0.3);
        }

        .order-title {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 8px;
            color: #ffdd44;
        }

        .order-item.selected .order-title {
            color: #1a1a2e;
        }

        .order-progress-info {
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .order-brief {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .order-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .order-status-active {
            display: inline-block;
            background-color: #4CAF50;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            position: absolute;
            top: 8px;
            right: 8px;
        }

        .order-status-expired {
            display: inline-block;
            background-color: #f44336;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            position: absolute;
            top: 8px;
            right: 8px;
        }

        .order-details h3 {
            color: #ffdd44;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .order-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .order-stat {
            background-color: #3a3a3a;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }

        .progress-chart-container {
            background-color: #3a3a3a;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .progress-chart-title {
            color: #ffdd44;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .progress-chart-wrapper {
            position: relative;
            height: 350px;
            width: 100%;
        }
        
        /* æ–°é—»æ¨¡å—æ ·å¼ */
        .news-container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .news-header {
            background: linear-gradient(135deg, #2a2a2a 0%, #333 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #444;
        }
        
        .news-header h3 {
            color: #ffdd44;
            margin: 0 0 15px 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .news-header .news-icon {
            font-size: 1.2rem;
        }
        
        .news-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .news-filter {
            background-color: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .news-filter:hover {
            background-color: #444;
            border-color: #ffdd44;
        }
        
        .news-filter:focus {
            outline: none;
            border-color: #ffdd44;
        }
        
        .news-stats {
            font-size: 0.9rem;
            color: #aaa;
            margin-left: auto;
        }
        
        .news-feed {
            background: linear-gradient(135deg, #2a2a2a 0%, #333 100%);
            border-radius: 12px;
            border: 1px solid #444;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .news-item {
            padding: 20px;
            border-bottom: 1px solid #444;
            transition: background-color 0.3s ease;
            position: relative;
        }
        
        .news-item:last-child {
            border-bottom: none;
        }
        
        .news-item:hover {
            background-color: rgba(255, 221, 68, 0.05);
        }
        
        .news-item.type-0 {
            border-left: 4px solid #4CAF50;
        }
        
        .news-item.type-1 {
            border-left: 4px solid #2196F3;
        }
        
        .news-item.type-2 {
            border-left: 4px solid #FF9800;
        }
        
        .news-item.type-3 {
            border-left: 4px solid #f44336;
        }
        
        .news-item.breaking {
            background: linear-gradient(90deg, rgba(255, 221, 68, 0.1) 0%, transparent 100%);
            border-left: 4px solid #ffdd44;
            animation: newsBreaking 2s ease-in-out infinite alternate;
        }
        
        @keyframes newsBreaking {
            0% { box-shadow: 0 0 5px rgba(255, 221, 68, 0.3); }
            100% { box-shadow: 0 0 15px rgba(255, 221, 68, 0.6); }
        }
        
        .news-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 0.85rem;
            color: #aaa;
        }
        
        .news-timestamp {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .news-type-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .news-type-badge.type-0 {
            background-color: #4CAF50;
            color: white;
        }
        
        .news-type-badge.type-1 {
            background-color: #2196F3;
            color: white;
        }
        
        .news-type-badge.type-2 {
            background-color: #FF9800;
            color: white;
        }
        
        .news-type-badge.type-3 {
            background-color: #f44336;
            color: white;
        }
        
        .news-content {
            line-height: 1.6;
            font-size: 1rem;
            color: #ffffff;
        }
        
        .news-content p {
            margin: 0 0 12px 0;
        }
        
        .news-content p:last-child {
            margin-bottom: 0;
        }
        
        .news-tags {
            margin-top: 12px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .news-tag {
            background-color: #444;
            color: #ffdd44;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
        }
        
        .news-loading {
            padding: 20px;
            text-align: center;
            color: #ffdd44;
            font-size: 1rem;
        }
        
        .news-loading-more {
            display: none;
            padding: 15px;
            text-align: center;
            color: #aaa;
            font-size: 0.9rem;
            border-top: 1px solid #444;
        }
        
        .news-loading-more.active {
            display: block;
        }
        
        .news-end-message {
            display: none;
            padding: 15px;
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #444;
            font-style: italic;
        }
        
        .news-end-message.active {
            display: block;
        }
        
        .news-empty {
            padding: 40px 20px;
            text-align: center;
            color: #aaa;
            font-size: 1.1rem;
        }
        
        .news-error {
            padding: 20px;
            text-align: center;
            color: #f44336;
            background-color: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            border-radius: 6px;
            margin: 20px;
        }
        
        /* æ–°é—»å†…å®¹æ ¼å¼åŒ– */
        .news-content em {
            font-style: italic;
            color: #ffdd44;
        }
        
        .news-content strong {
            font-weight: bold;
            color: #ffdd44;
        }
        
        .news-content [i="1"] {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .news-content [i="3"] {
            color: #f44336;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .news-feed::-webkit-scrollbar {
            width: 8px;
        }
        
        .news-feed::-webkit-scrollbar-track {
            background: #2a2a2a;
            border-radius: 4px;
        }
        
        .news-feed::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        
        .news-feed::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2rem;
            color: #ffdd44;
        }
        
        .error {
            background-color: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            text-align: center;
        }
        
        .data-controls {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .data-controls select {
            background-color: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 0 10px;
        }
        
        .battle-summary {
            background: linear-gradient(135deg, #2a2a2a 0%, #333 100%);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #ffdd44;
        }
        
        .battle-summary h4 {
            color: #ffdd44;
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .battle-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .battle-indicator {
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            background-color: #3a3a3a;
        }
        
        .battle-indicator.critical {
            background-color: #4a2c2c;
            border: 1px solid #f44336;
        }
        
        .battle-indicator.stable {
            background-color: #2c4a2c;
            border: 1px solid #4CAF50;
        }
        
        .battle-indicator.enemy {
            background-color: #3a3a3a;
            border: 1px solid #9E9E9E;
        }
        
        .api-info {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 3px solid #2196F3;
        }
        
        .api-info h4 {
            color: #2196F3;
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .api-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .api-item {
            background-color: #3a3a3a;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .api-label {
            font-weight: bold;
            color: #ffdd44;
        }
        
        @media (max-width: 1024px) {
            .orders-grid, .planets-grid {
                grid-template-columns: 1fr;
            }
            
            .orders-sidebar, .planets-sidebar {
                max-height: 300px;
            }
            
            .news-container {
                max-width: 95%;
            }
            
            .news-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .news-stats {
                margin-left: 0;
                margin-top: 10px;
            }
        }
        
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .regions-grid {
                grid-template-columns: 1fr;
            }
            
            .news-feed {
                max-height: 70vh;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”¥ Helldivers 2 æˆ˜äº‰ç›‘æ§ä»ªè¡¨ç›˜</h1>
        <div class="subtitle">å®æ—¶æˆ˜äº‰æ•°æ®åˆ†æ | å½“å‰æ—¶é—´: <span id="currentTime"></span></div>
    </div>
    
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('overview')">æ€»è§ˆ</button>
        <button class="nav-tab" onclick="switchTab('planets')">æ˜Ÿçƒæˆ˜å†µ</button>
        <button class="nav-tab" onclick="switchTab('orders')">ä¸»è¦è®¢å•</button>
        <button class="nav-tab" onclick="switchTab('news')">æˆ˜äº‰æ–°é—»</button>
        <button class="nav-tab" onclick="switchTab('statistics')">è¯¦ç»†ç»Ÿè®¡</button>
    </div>
    
    <!-- æ€»è§ˆæ ‡ç­¾é¡µ -->
    <div id="overview" class="tab-content active">
        <div class="data-controls">
            <label>æ—¶é—´èŒƒå›´:</label>
            <select id="overviewTimeRange" onchange="updateOverviewData()">
                <option value="6">6å°æ—¶</option>
                <option value="12">12å°æ—¶</option>
                <option value="24" selected>24å°æ—¶</option>
                <option value="48">48å°æ—¶</option>
                <option value="72">72å°æ—¶</option>
                <option value="168">7å¤©</option>
            </select>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <div class="loading">åŠ è½½ç»Ÿè®¡æ•°æ®ä¸­...</div>
        </div>
        
        <div class="charts-container">
            <div class="chart-container">
                <div class="chart-title">æˆ˜äº‰çŠ¶æ€è¶‹åŠ¿</div>
                <div class="chart-wrapper">
                    <canvas id="warStatusChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">å‡»æ€ç»Ÿè®¡è¶‹åŠ¿</div>
                <div class="chart-wrapper">
                    <canvas id="killStatsChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">ä»»åŠ¡æˆåŠŸç‡è¶‹åŠ¿</div>
                <div class="chart-wrapper">
                    <canvas id="missionSuccessChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">å…¨å±€èµ„æº</div>
                <div class="chart-wrapper">
                    <canvas id="resourcesChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">ç©å®¶æ´»è·ƒåº¦åˆ†æ</div>
                <div class="chart-wrapper">
                    <canvas id="playerActivityChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">æˆ˜äº‰å½±å“å› å­è¶‹åŠ¿</div>
                <div class="chart-wrapper">
                    <canvas id="impactMultiplierChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ˜Ÿçƒæˆ˜å†µæ ‡ç­¾é¡µ -->
    <div id="planets" class="tab-content">
        <div class="planets-container">
            <div class="planets-grid">
                <div class="planets-sidebar">
                    <h3 style="color: #ffdd44; margin-top: 0;">æ˜Ÿçƒåˆ—è¡¨ (æŒ‰Sectoråˆ†ç»„)</h3>
                    <div id="planetsListing">
                        <div class="loading">åŠ è½½æ˜Ÿçƒæ•°æ®ä¸­...</div>
                    </div>
                </div>
                <div class="planets-main">
                    <div id="planetDetails" class="planet-details">
                        <div class="loading">è¯·é€‰æ‹©ä¸€ä¸ªæ˜ŸçƒæŸ¥çœ‹è¯¦æƒ…</div>
                    </div>
                    
                    <!-- åœ°åŒºå›¾è¡¨å®¹å™¨ -->
                    <div id="regionCharts" class="region-charts">
                        <!-- æ–°å¢æ—¶é—´é€‰æ‹©æ§ä»¶ -->
                        <div class="data-controls" style="margin-bottom: 20px;">
                            <label>åœ°åŒºåˆ†ææ—¶é—´èŒƒå›´:</label>
                            <select id="regionTimeRange" onchange="updateRegionChartsData()">
                                <option value="6">6å°æ—¶</option>
                                <option value="12">12å°æ—¶</option>
                                <option value="24" selected>24å°æ—¶</option>
                                <option value="48">48å°æ—¶</option>
                                <option value="72">72å°æ—¶</option>
                                <option value="168">7å¤©</option>
                            </select>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">åœ°åŒºæˆ˜å†µåˆ†æ</div>
                            <div class="chart-wrapper">
                                <canvas id="regionHealthChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container" style="margin-top: 20px;">
                            <div class="chart-title">çœŸå®å é¢†åº¦å˜åŒ–</div>
                            <div class="chart-wrapper">
                                <canvas id="regionControlChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ä¸»è¦è®¢å•æ ‡ç­¾é¡µ -->
    <div id="orders" class="tab-content">
        <div class="data-controls">
            <label>æ—¶é—´èŒƒå›´:</label>
            <select id="ordersTimeRange" onchange="updateOrdersData()">
                <option value="6">6å°æ—¶</option>
                <option value="12">12å°æ—¶</option>
                <option value="24">24å°æ—¶</option>
                <option value="48" selected>48å°æ—¶</option>
                <option value="72">72å°æ—¶</option>
                <option value="168">7å¤©</option>
            </select>
        </div>
        
        <div class="orders-container">
            <!-- è®¢å•æ€»è§ˆç½‘æ ¼ -->
            <div class="orders-grid">
                <div class="orders-sidebar">
                    <h3 style="color: #ffdd44; margin-top: 0;">æ´»è·ƒè®¢å•åˆ—è¡¨</h3>
                    <div id="ordersList">
                        <div class="loading">åŠ è½½è®¢å•æ•°æ®ä¸­...</div>
                    </div>
                </div>
                <div class="orders-main">
                    <div id="orderDetails" class="order-details">
                        <div class="loading">è¯·é€‰æ‹©ä¸€ä¸ªè®¢å•æŸ¥çœ‹è¯¦ç»†è¿›åº¦</div>
                    </div>
                </div>
            </div>
            
            <!-- æ•´ä½“ç»Ÿè®¡å›¾è¡¨ -->
            <div class="charts-container" style="margin-top: 30px;">
                <div class="chart-container">
                    <div class="chart-title">æ‰€æœ‰è®¢å•æ•´ä½“è¿›åº¦æ¦‚è§ˆ</div>
                    <div class="chart-wrapper">
                        <canvas id="majorOrdersOverviewChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">è®¢å•æ—¶é—´çº¿</div>
                    <div id="ordersTimeline">
                        <div class="loading">åŠ è½½è®¢å•æ•°æ®ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æˆ˜äº‰æ–°é—»æ ‡ç­¾é¡µ -->
    <div id="news" class="tab-content">
        <div class="news-container">
            <!-- æ–°é—»å¤´éƒ¨æ§åˆ¶åŒº -->
            <div class="news-header">
                <h3>
                    <span class="news-icon">ğŸ“°</span>
                    æˆ˜äº‰æ–°é—»ä¸­å¿ƒ
                </h3>
                <div class="news-controls">
                    <select id="newsTypeFilter" class="news-filter" onchange="filterNewsByType()">
                        <option value="">æ‰€æœ‰ç±»å‹</option>
                        <option value="0">å¸¸è§„æ–°é—»</option>
                        <option value="1">é‡è¦é€šçŸ¥</option>
                        <option value="2">æˆ˜å†µæ›´æ–°</option>
                        <option value="3">ç´§æ€¥è­¦æŠ¥</option>
                    </select>
                    
                    <button id="refreshNewsBtn" class="news-filter" onclick="refreshNews()">
                        ğŸ”„ åˆ·æ–°æ–°é—»
                    </button>
                    
                    <div class="news-stats" id="newsStats">
                        <span id="newsCount">åŠ è½½ä¸­...</span>
                    </div>
                </div>
            </div>
            
            <!-- æ–°é—»å†…å®¹åŒºåŸŸ -->
            <div class="news-feed" id="newsFeed">
                <div class="news-loading">
                    ğŸ“¡ æ­£åœ¨è·å–æœ€æ–°æˆ˜äº‰æƒ…æŠ¥...
                </div>
            </div>
        </div>
    </div>
    
    <!-- è¯¦ç»†ç»Ÿè®¡æ ‡ç­¾é¡µ -->
    <div id="statistics" class="tab-content">
        <div class="data-controls">
            <label>æ—¶é—´èŒƒå›´:</label>
            <select id="statsTimeRange" onchange="updateStatsData()">
                <option value="6">6å°æ—¶</option>
                <option value="12">12å°æ—¶</option>
                <option value="24" selected>24å°æ—¶</option>
                <option value="48">48å°æ—¶</option>
                <option value="72">72å°æ—¶</option>
                <option value="168">7å¤©</option>
            </select>
        </div>
        
        <div class="charts-container">
            <div class="chart-container">
                <div class="chart-title">ç©å®¶åˆ†å¸ƒçƒ­åŠ›å›¾</div>
                <div class="chart-wrapper">
                    <canvas id="playerDistributionChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">æ˜Ÿçƒç”Ÿå‘½å€¼è¶‹åŠ¿</div>
                <div class="chart-wrapper">
                    <canvas id="planetHealthTrendChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">æˆ˜äº‰å¼ºåº¦åˆ†æ</div>
                <div class="chart-wrapper">
                    <canvas id="warIntensityChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">é˜µè¥æ§åˆ¶å˜åŒ–</div>
                <div class="chart-wrapper">
                    <canvas id="factionControlChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">èµ„æºæ”¶é›†æ•ˆç‡</div>
                <div class="chart-wrapper">
                    <canvas id="resourceEfficiencyChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">ä»»åŠ¡ç±»å‹åˆ†æ</div>
                <div class="chart-wrapper">
                    <canvas id="missionTypeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentPlanetData = null;
        let currentSelectedPlanet = null;
        let currentSelectedRegion = null;
        let currentSelectedOrder = null;
        let ordersData = [];
        let allChartsData = {};
        let planetHistoryData = {}; // ç¼“å­˜å†å²æ•°æ®ç”¨äºè®¡ç®—çœŸå®å˜åŒ–ç‡
        
        // æ–°é—»ç›¸å…³å…¨å±€å˜é‡
        let newsData = [];
        let newsCurrentPage = 0;
        let newsPageSize = 5;
        let newsIsLoading = false;
        let newsHasMore = true;
        let newsCurrentFilter = '';
        let newsStats = {};
        
        // å·¥å…·å‡½æ•°
        function formatNumber(num) {
            if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
            return num.toString();
        }

        function formatTimestamp(timestamp) {
            return new Date(timestamp * 1000).toLocaleTimeString();
        }
        
        function updateCurrentTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString();
        }
        
        // è®¡ç®—çœŸå®å é¢†åº¦å’Œå˜åŒ–ç‡ï¼ˆåŸºäºå†å²æ•°æ®ï¼‰
        function calculateRealControlChange(currentHealth, maxHealth, planetIndex, owner, regionIndex = null) {
            if(owner !== 1) { currentHealth = -currentHealth };
            let currentControl = (currentHealth / maxHealth) * 100;
            
            // ä»å†å²æ•°æ®ä¸­è®¡ç®—å˜åŒ–ç‡
            const historyKey = regionIndex !== null ? `${planetIndex}_${regionIndex}` : `${planetIndex}`;

            if(true) {
                if (planetHistoryData[historyKey] && planetHistoryData[historyKey].length > 1) {
                    const history = planetHistoryData[historyKey];
                    const previousData = history[history.length - 2];
                    const currentData = history[history.length - 1];
                    
                    const previousControl = ((owner !== 1?-previousData.health:previousData.health) / maxHealth) * 100;
                    const timeDiff = (currentData.timestamp - previousData.timestamp) / 3600; // å°æ—¶
                    
                    const controlChange = currentControl - previousControl;
                    const changeRate = timeDiff > 0 ? controlChange / timeDiff : 0; // æ¯å°æ—¶å˜åŒ–ç‡
                    
                    return {
                        currentControl: currentControl,
                        controlChange: controlChange,
                        changeRate: changeRate,
                        isAccurate: true
                    };
                }
            } else {
                let previousControl = 0;
                currentControl = 0;
                let timeDiff = null;
                for(regionIndex=0; ; regionIndex++) {
                    if (planetHistoryData[historyKey+'_'+regionIndex] && planetHistoryData[historyKey+'_'+regionIndex].length > 1) {
                        const history = planetHistoryData[historyKey+'_'+regionIndex];
                        const previousData = history[history.length - 2];
                        const currentData = history[history.length - 1];
                        
                        previousControl += ((previousData.owner === 1 ? previousData.health : 0) / 600000) * 100;
                        currentControl += ((currentData.owner === 1 ? currentData.health : 0) / 600000) * 100;
                        if (timeDiff === null) timeDiff = (currentData.timestamp - previousData.timestamp) / 3600; // å°æ—¶
                    } else {
                        if (regionIndex===0&&owner===1) {
                            return {
                                currentControl: 100,
                                controlChange: 0,
                                changeRate: 0,
                                isAccurate: true
                            };
                        }
                        const controlChange = currentControl - previousControl;
                        const changeRate = timeDiff > 0 ? controlChange / timeDiff : 0; // æ¯å°æ—¶å˜åŒ–ç‡
                        
                        return {
                            currentControl: currentControl/regionIndex,
                            controlChange: controlChange/regionIndex,
                            changeRate: changeRate/regionIndex,
                            isAccurate: true
                        };
                    }
                }
            }
            
            return {
                currentControl: currentControl,
                controlChange: 0,
                changeRate: 0,
                isAccurate: false
            };
        }
        
        // åˆ†æçœŸå®æˆ˜å†µçŠ¶æ€ï¼ˆåŸºäºå®é™…æ•°æ®è€ŒéAPIæä¾›çš„æ•°æ®ï¼‰
        function analyzeRealBattleStatus(regionData, controlChangeData, owner) {
            const controlPercent = controlChangeData.currentControl;
            const changeRate = controlChangeData.changeRate;
            
            // åˆ¤æ–­æ˜¯å¦è¢«æ•Œæ–¹æ§åˆ¶
            //if (regionData.owner !== 1) {
            //    return {
            //        status: 'enemy-controlled',
            //        description: 'æ•Œæ–¹æ§åˆ¶',
            //        color: '#9E9E9E',
            //        priority: 0,
            //        isEnemyControlled: true
            //    };
            //}
            
            // åˆ¤æ–­è¶…çº§åœ°çƒæ§åˆ¶åŒºåŸŸçš„æˆ˜å†µ
            if ((controlPercent < 10 || changeRate < -3) && owner === 1) {
                return {
                    status: 'critical',
                    description: 'å±æ€¥å¤±å®ˆ',
                    color: '#f44336',
                    priority: regionData.owner !== 1?0:5,
                    isEnemyControlled: regionData.owner !== 1
                };
            } else if (controlPercent < 20 && changeRate < 0 && owner === 1) {
                return {
                    status: 'under-fierce-attack',
                    description: 'æ¿€æˆ˜ä¸­',
                    color: '#ff9800',
                    priority: regionData.owner !== 1?0:4,
                    isEnemyControlled: regionData.owner !== 1
                };
            } else if (changeRate > 0) {
                return {
                    status: 'gaining',
                    description: 'æ”¶å¤ä¸­',
                    color: '#2196f3',
                    priority: regionData.owner !== 1?0:2,
                    isEnemyControlled: regionData.owner !== 1
                };
            } else if (changeRate < 0) {
                return {
                    status: 'losing',
                    description: 'å¤±å®ˆä¸­',
                    color: '#f3e721',
                    priority: regionData.owner !== 1?0:3,
                    isEnemyControlled: regionData.owner !== 1
                };
            } else if (changeRate === 0 && (controlPercent == 100 || controlPercent == -100)) {
                return {
                    status: 'stable',
                    description: 'æœªäº¤æˆ˜',
                    color: '#4CAF50',
                    priority: regionData.owner !== 1?0:1,
                    isEnemyControlled: regionData.owner !== 1
                };
            } else {
                return {
                    status: 'contested',
                    description: 'äº¤æˆ˜ä¸­',
                    color: '#f3e721',
                    priority: regionData.owner !== 1?0:2,
                    isEnemyControlled: regionData.owner !== 1
                };
            }
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'planets' && !currentPlanetData) {
                loadPlanetsData();
            } else if (tabName === 'orders' && ordersData.length === 0) {
                updateOrdersData();
            } else if (tabName === 'news' && newsData.length === 0) {
                loadNewsData(true);
            }
        }
        
        function getFactionName(owner) {
            const factions = {
                1: 'è¶…çº§åœ°çƒ',
                2: 'è™«æ—',
                3: 'æœºæ¢°æ—', 
                4: 'å…‰æ˜æ—'
            };
            return factions[owner] || 'æœªçŸ¥';
        }
        
        function getFactionClass(owner) {
            const factionClasses = {
                1: 'super-earth',
                2: 'terminids',
                3: 'automatons',
                4: 'illuminate'
            };
            return factionClasses[owner] || '';
        }

        // å›¾è¡¨é…ç½®
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 300
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#ffffff',
                        font: {
                            size: 12
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { 
                        color: '#ffffff',
                        font: { size: 10 },
                        maxTicksLimit: 10
                    },
                    grid: { color: '#444' }
                },
                y: {
                    ticks: { 
                        color: '#ffffff',
                        font: { size: 10 }
                    },
                    grid: { color: '#444' }
                }
            },
            elements: {
                point: {
                    radius: 2
                }
            }
        };

        // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
        function initializeCharts() {
            // æˆ˜äº‰çŠ¶æ€å›¾è¡¨
            const warStatusCtx = document.getElementById('warStatusChart').getContext('2d');
            allChartsData.warStatusChart = new Chart(warStatusCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'è¶…çº§åœ°çƒæ˜Ÿçƒæ•°',
                            data: [],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'æ•Œæ–¹æ˜Ÿçƒæ•°',
                            data: [],
                            borderColor: '#F44336',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'åœ¨çº¿ç©å®¶æ•°',
                            data: [],
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.1,
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#ffffff', font: { size: 10 } },
                            grid: { drawOnChartArea: false, color: '#444' }
                        }
                    }
                }
            });

            // å‡»æ€ç»Ÿè®¡å›¾è¡¨
            const killStatsCtx = document.getElementById('killStatsChart').getContext('2d');
            allChartsData.killStatsChart = new Chart(killStatsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'è™«æ—å‡»æ€(B)',
                            data: [],
                            borderColor: '#8BC34A',
                            backgroundColor: 'rgba(139, 195, 74, 0.1)',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'æœºæ¢°æ—å‡»æ€(B)',
                            data: [],
                            borderColor: '#FF9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.1)',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'å…‰æ˜æ—å‡»æ€(B)',
                            data: [],
                            borderColor: '#9C27B0',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: chartOptions
            });

            // ä»»åŠ¡æˆåŠŸç‡å›¾è¡¨
            const missionSuccessCtx = document.getElementById('missionSuccessChart').getContext('2d');
            allChartsData.missionSuccessChart = new Chart(missionSuccessCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ä»»åŠ¡æˆåŠŸç‡(%)',
                        data: [],
                        borderColor: '#ffdd44',
                        backgroundColor: 'rgba(255, 221, 68, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: chartOptions
            });

            // è®¢å•æ¦‚è§ˆå›¾è¡¨
            const majorOrdersCtx = document.getElementById('majorOrdersOverviewChart').getContext('2d');
            allChartsData.majorOrdersOverviewChart = new Chart(majorOrdersCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'è®¢å•è¿›åº¦(%)',
                        data: [],
                        backgroundColor: '#ffdd44',
                        borderColor: '#ffaa00',
                        borderWidth: 1
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // èµ„æºå›¾è¡¨
            const resourcesCtx = document.getElementById('resourcesChart').getContext('2d');
            allChartsData.resourcesChart = new Chart(resourcesCtx, {
                type: 'doughnut',
                data: {
                    labels: ['å·²æ”¶é›†', 'å‰©ä½™'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#00BCD4', '#444'],
                        borderColor: ['#00BCD4', '#444'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    }
                }
            });

            // ç©å®¶æ´»è·ƒåº¦åˆ†æå›¾è¡¨
            const playerActivityCtx = document.getElementById('playerActivityChart').getContext('2d');
            allChartsData.playerActivityChart = new Chart(playerActivityCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æ´»è·ƒç©å®¶æ¯”ä¾‹(%)',
                        data: [],
                        borderColor: '#FF5722',
                        backgroundColor: 'rgba(255, 87, 34, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: chartOptions
            });

            // æˆ˜äº‰å½±å“å› å­å›¾è¡¨
            const impactMultiplierCtx = document.getElementById('impactMultiplierChart').getContext('2d');
            allChartsData.impactMultiplierChart = new Chart(impactMultiplierCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æˆ˜äº‰å½±å“å› å­',
                        data: [],
                        borderColor: '#9C27B0',
                        backgroundColor: 'rgba(156, 39, 176, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: chartOptions
            });

            // ç©å®¶åˆ†å¸ƒå›¾è¡¨
            const playerDistributionCtx = document.getElementById('playerDistributionChart').getContext('2d');
            allChartsData.playerDistributionChart = new Chart(playerDistributionCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ç©å®¶æ•°é‡',
                        data: [],
                        backgroundColor: '#2196F3',
                        borderColor: '#1976D2',
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            });

            // æ˜Ÿçƒç”Ÿå‘½å€¼è¶‹åŠ¿å›¾è¡¨
            const planetHealthTrendCtx = document.getElementById('planetHealthTrendChart').getContext('2d');
            allChartsData.planetHealthTrendChart = new Chart(planetHealthTrendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: chartOptions
            });

            // æˆ˜äº‰å¼ºåº¦åˆ†æå›¾è¡¨
            const warIntensityCtx = document.getElementById('warIntensityChart').getContext('2d');
            allChartsData.warIntensityChart = new Chart(warIntensityCtx, {
                type: 'radar',
                data: {
                    labels: ['æ€»ç©å®¶æ•°', 'æ´»è·ƒæ˜Ÿçƒ', 'æ¿€æˆ˜åœ°åŒº', 'ä»»åŠ¡æˆåŠŸç‡', 'å‡»æ€æ•ˆç‡', 'èµ„æºæ”¶é›†'],
                    datasets: [{
                        label: 'æˆ˜äº‰å¼ºåº¦',
                        data: [],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.2)',
                        pointBackgroundColor: '#ff6b6b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        r: {
                            angleLines: { color: '#444' },
                            grid: { color: '#444' },
                            pointLabels: { color: '#ffffff', font: { size: 10 } },
                            ticks: { color: '#ffffff', backdropColor: 'transparent' }
                        }
                    }
                }
            });

            // é˜µè¥æ§åˆ¶å˜åŒ–å›¾è¡¨
            const factionControlCtx = document.getElementById('factionControlChart').getContext('2d');
            allChartsData.factionControlChart = new Chart(factionControlCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'è¶…çº§åœ°çƒæ§åˆ¶ç‡',
                            data: [],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'è™«æ—æ§åˆ¶ç‡',
                            data: [],
                            borderColor: '#8BC34A',
                            backgroundColor: 'rgba(139, 195, 74, 0.1)',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'æœºæ¢°æ—æ§åˆ¶ç‡',
                            data: [],
                            borderColor: '#FF9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.1)',
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: chartOptions
            });

            // èµ„æºæ”¶é›†æ•ˆç‡å›¾è¡¨
            const resourceEfficiencyCtx = document.getElementById('resourceEfficiencyChart').getContext('2d');
            allChartsData.resourceEfficiencyChart = new Chart(resourceEfficiencyCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æ”¶é›†æ•ˆç‡(æ¯å°æ—¶)',
                        data: [],
                        backgroundColor: '#00BCD4',
                        borderColor: '#00ACC1',
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            });

            // ä»»åŠ¡ç±»å‹åˆ†æå›¾è¡¨
            const missionTypeCtx = document.getElementById('missionTypeChart').getContext('2d');
            allChartsData.missionTypeChart = new Chart(missionTypeCtx, {
                type: 'pie',
                data: {
                    labels: ['è§£æ”¾ä»»åŠ¡', 'é˜²å¾¡ä»»åŠ¡', 'ç‰¹æ®Šè¡ŒåŠ¨', 'å…¶ä»–'],
                    datasets: [{
                        data: [40, 30, 20, 10],
                        backgroundColor: ['#4CAF50', '#FF9800', '#9C27B0', '#607D8B'],
                        borderColor: ['#4CAF50', '#FF9800', '#9C27B0', '#607D8B'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    }
                }
            });

            // åœ°åŒºç”Ÿå‘½å€¼å›¾è¡¨
            const regionHealthCtx = document.getElementById('regionHealthChart').getContext('2d');
            allChartsData.regionHealthChart = new Chart(regionHealthCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ç”Ÿå‘½å€¼',
                        data: [],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        tension: 0.1,
                        fill: true,
                        yAxisID: 'y'
                    }, {
                        label: 'ç©å®¶æ•°é‡',
                        data: [],
                        borderColor: '#4ecdc4',
                        backgroundColor: 'rgba(78, 205, 196, 0.1)',
                        tension: 0.1,
                        fill: false,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            title: {
                                display: true,
                                text: 'ç”Ÿå‘½å€¼',
                                color: '#ff6b6b'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#ffffff', font: { size: 10 } },
                            grid: { drawOnChartArea: false, color: '#444' },
                            title: {
                                display: true,
                                text: 'ç©å®¶æ•°é‡',
                                color: '#4ecdc4'
                            }
                        }
                    }
                }
            });

            // åœ°åŒºçœŸå®å é¢†åº¦å˜åŒ–å›¾è¡¨
            const regionControlCtx = document.getElementById('regionControlChart').getContext('2d');
            allChartsData.regionControlChart = new Chart(regionControlCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'å é¢†åº¦(%)',
                        data: [],
                        borderColor: '#4ecdc4',
                        backgroundColor: 'rgba(78, 205, 196, 0.1)',
                        tension: 0.1,
                        fill: true,
                        yAxisID: 'y'
                    }, {
                        label: 'çœŸå®å˜åŒ–ç‡(%/h)',
                        data: [],
                        borderColor: '#ffdd44',
                        backgroundColor: 'rgba(255, 221, 68, 0.1)',
                        tension: 0.1,
                        fill: false,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            min: -100,
                            max: 100,
                            title: {
                                display: true,
                                text: 'å é¢†åº¦(%)',
                                color: '#4ecdc4'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#ffffff', font: { size: 10 } },
                            grid: { drawOnChartArea: false, color: '#444' },
                            title: {
                                display: true,
                                text: 'å˜åŒ–ç‡(%/h)',
                                color: '#ffdd44'
                            }
                        }
                    }
                }
            });
        }

        // æ•°æ®è·å–å’Œæ›´æ–°å‡½æ•°
        async function fetchAndUpdateData() {
            const timeRange = document.getElementById('overviewTimeRange')?.value || 24;
            
            try {
                // è·å–æˆ˜äº‰çŠ¶æ€æ•°æ®
                const warStatusResponse = await fetch(`/api/war-status-trend?hours=${timeRange}&limit=1000`);
                const warStatusData = await warStatusResponse.json();
                
                if (warStatusData.length > 0) {
                    const labels = warStatusData.map(d => formatTimestamp(d.timestamp));
                    
                    // æ›´æ–°æˆ˜äº‰çŠ¶æ€å›¾è¡¨
                    allChartsData.warStatusChart.data.labels = labels;
                    allChartsData.warStatusChart.data.datasets[0].data = warStatusData.map(d => d.super_earth_planets);
                    allChartsData.warStatusChart.data.datasets[1].data = warStatusData.map(d => d.enemy_planets);
                    allChartsData.warStatusChart.data.datasets[2].data = warStatusData.map(d => d.total_players);
                    allChartsData.warStatusChart.update('none');
                    
                    // æ›´æ–°ç©å®¶æ´»è·ƒåº¦å›¾è¡¨
                    const totalPlanets = warStatusData.map(d => d.super_earth_planets + d.enemy_planets);
                    const activePlanetsRatio = warStatusData.map((d, i) => {
                        const total = totalPlanets[i];
                        return total > 0 ? (d.super_earth_planets / total * 100) : 0;
                    });
                    allChartsData.playerActivityChart.data.labels = labels;
                    allChartsData.playerActivityChart.data.datasets[0].data = activePlanetsRatio;
                    allChartsData.playerActivityChart.update('none');
                    
                    // æ›´æ–°æˆ˜äº‰å½±å“å› å­å›¾è¡¨
                    allChartsData.impactMultiplierChart.data.labels = labels;
                    allChartsData.impactMultiplierChart.data.datasets[0].data = warStatusData.map(d => d.impact_multiplier || 1);
                    allChartsData.impactMultiplierChart.update('none');
                    
                    // æ›´æ–°é˜µè¥æ§åˆ¶å˜åŒ–å›¾è¡¨
                    allChartsData.factionControlChart.data.labels = labels;
                    allChartsData.factionControlChart.data.datasets[0].data = warStatusData.map(d => {
                        const total = d.super_earth_planets + d.enemy_planets;
                        return total > 0 ? (d.super_earth_planets / total * 100) : 0;
                    });
                    allChartsData.factionControlChart.data.datasets[1].data = warStatusData.map(d => {
                        const total = d.super_earth_planets + d.enemy_planets;
                        return total > 0 ? (d.enemy_planets * 0.4 / total * 100) : 0; // å‡è®¾40%ä¸ºè™«æ—
                    });
                    allChartsData.factionControlChart.data.datasets[2].data = warStatusData.map(d => {
                        const total = d.super_earth_planets + d.enemy_planets;
                        return total > 0 ? (d.enemy_planets * 0.6 / total * 100) : 0; // å‡è®¾60%ä¸ºæœºæ¢°æ—
                    });
                    allChartsData.factionControlChart.update('none');
                }

                // è·å–ä¸»è¦è®¢å•æ•°æ®
                const majorOrdersResponse = await fetch('/api/major-orders-progress?limit=10');
                const majorOrdersData = await majorOrdersResponse.json();
                
                if (majorOrdersData.length > 0) {
                    allChartsData.majorOrdersOverviewChart.data.labels = majorOrdersData.map(d => 
                        d.title && d.title.length > 15 ? d.title.substring(0, 15) + '...' : (d.title || 'æœªçŸ¥è®¢å•')
                    );
                    allChartsData.majorOrdersOverviewChart.data.datasets[0].data = majorOrdersData.map(d => d.progress_percentage || 0);
                    allChartsData.majorOrdersOverviewChart.update('none');
                }

                // è·å–æˆ˜äº‰ç»Ÿè®¡æ•°æ®
                const warStatsResponse = await fetch(`/api/war-stats-trend?hours=${timeRange}&limit=1000`);
                const warStatsData = await warStatsResponse.json();
                
                if (warStatsData.length > 0) {
                    const labels = warStatsData.map(d => formatTimestamp(d.timestamp));
                    
                    // æ›´æ–°å‡»æ€ç»Ÿè®¡
                    allChartsData.killStatsChart.data.labels = labels;
                    allChartsData.killStatsChart.data.datasets[0].data = warStatsData.map(d => d.bug_kills / 1e9);
                    allChartsData.killStatsChart.data.datasets[1].data = warStatsData.map(d => d.automaton_kills / 1e9);
                    allChartsData.killStatsChart.data.datasets[2].data = warStatsData.map(d => d.illuminate_kills / 1e9);
                    allChartsData.killStatsChart.update('none');
                    
                    // æ›´æ–°ä»»åŠ¡æˆåŠŸç‡
                    allChartsData.missionSuccessChart.data.labels = labels;
                    allChartsData.missionSuccessChart.data.datasets[0].data = warStatsData.map(d => d.mission_success_rate);
                    allChartsData.missionSuccessChart.update('none');

                    // æ›´æ–°ç»Ÿè®¡å¡ç‰‡ï¼ˆå¢åŠ æ›´å¤šAPIå‚æ•°ï¼‰
                    updateEnhancedStatsCards(warStatsData[warStatsData.length - 1], warStatusData[warStatusData.length - 1]);
                    
                    // æ›´æ–°æˆ˜äº‰å¼ºåº¦é›·è¾¾å›¾
                    const latestStats = warStatsData[warStatsData.length - 1];
                    const latestWarStatus = warStatusData[warStatusData.length - 1];
                    const intensityData = [
                        Math.min(latestWarStatus.total_players / 100000 * 100, 100), // æ€»ç©å®¶æ•°æ ‡å‡†åŒ–
                        Math.min(latestWarStatus.super_earth_planets / 50 * 100, 100), // æ´»è·ƒæ˜Ÿçƒæ ‡å‡†åŒ–
                        Math.min(latestWarStatus.enemy_planets / 30 * 100, 100), // æ¿€æˆ˜åœ°åŒºæ ‡å‡†åŒ–
                        latestStats.mission_success_rate, // ä»»åŠ¡æˆåŠŸç‡
                        Math.min((latestStats.bug_kills + latestStats.automaton_kills + latestStats.illuminate_kills) / 1e12 * 100, 100), // å‡»æ€æ•ˆç‡æ ‡å‡†åŒ–
                        Math.min(latestStats.accuracy, 100) // å°„å‡»å‡†ç¡®ç‡
                    ];
                    allChartsData.warIntensityChart.data.datasets[0].data = intensityData;
                    allChartsData.warIntensityChart.update('none');
                }

                // è·å–èµ„æºæ•°æ®
                const resourcesResponse = await fetch(`/api/global-resources-trend?hours=${timeRange}&limit=1000`);
                const resourcesData = await resourcesResponse.json();
                
                if (resourcesData.length > 0) {
                    const latestResource = resourcesData[resourcesData.length - 1];
                    const percentage = latestResource.percentage;
                    allChartsData.resourcesChart.data.datasets[0].data = [percentage, 100 - percentage];
                    allChartsData.resourcesChart.update('none');
                    
                    // æ›´æ–°èµ„æºæ”¶é›†æ•ˆç‡å›¾è¡¨
                    const resourceLabels = resourcesData.map(d => formatTimestamp(d.timestamp));
                    const efficiencyData = [];
                    for (let i = 1; i < resourcesData.length; i++) {
                        const current = resourcesData[i];
                        const previous = resourcesData[i - 1];
                        const timeDiff = (current.timestamp - previous.timestamp) / 3600; // å°æ—¶
                        const valueDiff = current.current_value - previous.current_value;
                        const efficiency = timeDiff > 0 ? valueDiff / timeDiff : 0;
                        efficiencyData.push(Math.max(0, efficiency));
                    }
                    
                    allChartsData.resourceEfficiencyChart.data.labels = resourceLabels.slice(1);
                    allChartsData.resourceEfficiencyChart.data.datasets[0].data = efficiencyData;
                    allChartsData.resourceEfficiencyChart.update('none');
                }

            } catch (error) {
                console.error('è·å–æ•°æ®æ—¶å‡ºé”™:', error);
                document.querySelector('.stats-grid').innerHTML = 
                    '<div class="error">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
            }
        }

        function updateOverviewData() {
            fetchAndUpdateData();
        }

        function updateStatsData() {
            const timeRange = document.getElementById('statsTimeRange').value;
            updatePlayerDistribution(timeRange);
            updatePlanetHealthTrend(timeRange);
        }

        async function updatePlayerDistribution(timeRange = 24) {
            try {
                const response = await fetch(`/api/planets-by-sector`);
                const data = await response.json();
                
                if (data.sectors) {
                    const planetsWithPlayers = [];
                    Object.values(data.sectors).forEach(planets => {
                        planets.forEach(planet => {
                            if (planet.players > 0) {
                                planetsWithPlayers.push(planet);
                            }
                        });
                    });
                    
                    planetsWithPlayers.sort((a, b) => b.players - a.players);
                    const top20 = planetsWithPlayers.slice(0, 20);
                    
                    allChartsData.playerDistributionChart.data.labels = top20.map(p => `æ˜Ÿçƒ #${p.index}`);
                    allChartsData.playerDistributionChart.data.datasets[0].data = top20.map(p => p.players);
                    allChartsData.playerDistributionChart.update('none');
                }
            } catch (error) {
                console.error('æ›´æ–°ç©å®¶åˆ†å¸ƒå¤±è´¥:', error);
            }
        }

        async function updatePlanetHealthTrend(timeRange = 24) {
            try {
                const planetsResponse = await fetch('/api/planets-by-sector');
                const planetsData = await planetsResponse.json();
                
                if (!planetsData.sectors) return;
                
                const activePlanets = [];
                Object.values(planetsData.sectors).forEach(planets => {
                    planets.forEach(planet => {
                        if (planet.players > 0) {
                            activePlanets.push(planet);
                        }
                    });
                });
                
                activePlanets.sort((a, b) => b.players - a.players);
                const top5Planets = activePlanets.slice(0, 5);
                
                const datasets = [];
                const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57'];
                
                for (let i = 0; i < top5Planets.length; i++) {
                    const planet = top5Planets[i];
                    const healthResponse = await fetch(`/api/planet-health-history/${planet.index}?hours=${timeRange}&limit=30`);
                    const healthData = await healthResponse.json();
                    
                    const res = await fetch(`/api/planet-details/${planet.index}`);
                    const ownerData = await res.json();
                    const planetOwner = ownerData.planet.owner;
                    
                    if (healthData.length > 0) {
                        datasets.push({
                            label: `æ˜Ÿçƒ #${planet.index}`,
                            data: healthData.map(d => (planetOwner===1?d.health:-d.health / planet.max_health * 100).toFixed(1)),
                            borderColor: colors[i],
                            backgroundColor: colors[i] + '20',
                            tension: 0.1,
                            fill: false
                        });
                        
                        if (i === 0) {
                            allChartsData.planetHealthTrendChart.data.labels = healthData.map(d => formatTimestamp(d.timestamp));
                        }
                    }
                }
                
                allChartsData.planetHealthTrendChart.data.datasets = datasets;
                allChartsData.planetHealthTrendChart.update('none');
                
            } catch (error) {
                console.error('æ›´æ–°æ˜Ÿçƒç”Ÿå‘½å€¼è¶‹åŠ¿å¤±è´¥:', error);
            }
        }

        function updateEnhancedStatsCards(latestStats, latestWarStatus) {
            const statsGrid = document.getElementById('statsGrid');
            
            // è®¡ç®—é¢å¤–çš„ç»Ÿè®¡æ•°æ®
            const totalKills = latestStats.bug_kills + latestStats.automaton_kills + latestStats.illuminate_kills;
            const killDeathRatio = latestStats.total_deaths > 0 ? (totalKills / latestStats.total_deaths).toFixed(2) : 'âˆ';
            const planetsControlled = latestWarStatus.super_earth_planets;
            const totalPlanets = latestWarStatus.super_earth_planets + latestWarStatus.enemy_planets;
            const controlPercentage = totalPlanets > 0 ? (planetsControlled / totalPlanets * 100).toFixed(1) : '0';
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${formatNumber(latestStats.missions_won)}</div>
                    <div class="stat-label">ä»»åŠ¡èƒœåˆ©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${latestStats.mission_success_rate.toFixed(1)}%</div>
                    <div class="stat-label">èƒœç‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatNumber(totalKills)}</div>
                    <div class="stat-label">æ€»å‡»æ€æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatNumber(latestStats.total_deaths)}</div>
                    <div class="stat-label">æ€»æ­»äº¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${killDeathRatio}</div>
                    <div class="stat-label">å‡»æ€æ­»äº¡æ¯”</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${latestStats.accuracy.toFixed(1)}%</div>
                    <div class="stat-label">å°„å‡»å‡†ç¡®ç‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${controlPercentage}%</div>
                    <div class="stat-label">æ˜Ÿçƒæ§åˆ¶ç‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatNumber(latestWarStatus.total_players)}</div>
                    <div class="stat-label">åœ¨çº¿ç©å®¶</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${(latestWarStatus.impact_multiplier || 1).toFixed(4)}</div>
                    <div class="stat-label">æˆ˜äº‰å½±å“å› å­</div>
                </div>
            `;
        }

        // è®¢å•ç›¸å…³å‡½æ•°ï¼ˆä¿æŒä¸å˜ï¼‰
        async function updateOrdersData() {
            const timeRange = document.getElementById('ordersTimeRange')?.value || 48;
            
            try {
                const summaryResponse = await fetch('/api/all-major-orders-summary');
                const summaryData = await summaryResponse.json();
                
                ordersData = summaryData;
                displayOrdersList(summaryData);
                updateOrdersOverview(summaryData);
                updateOrdersTimeline(summaryData);
                
                if (currentSelectedOrder) {
                    displayOrderDetails(currentSelectedOrder, timeRange);
                }
                
            } catch (error) {
                console.error('è·å–è®¢å•æ•°æ®å¤±è´¥:', error);
                document.getElementById('ordersList').innerHTML = 
                    '<div class="error">è®¢å•æ•°æ®åŠ è½½å¤±è´¥</div>';
            }
        }

        // æ–°å¢ï¼šåœ°åŒºå›¾è¡¨æ—¶é—´é€‰æ‹©æ›´æ–°å‡½æ•°
        function updateRegionChartsData() {
            const timeRange = document.getElementById('regionTimeRange')?.value || 24;
            
            // å¦‚æœå½“å‰æœ‰é€‰ä¸­çš„åœ°åŒºï¼Œé‡æ–°åŠ è½½è¯¥åœ°åŒºçš„å›¾è¡¨æ•°æ®
            if (typeof currentSelectedPlanet !== 'undefined' && typeof currentSelectedRegion !== 'undefined' && currentSelectedPlanet != null && currentSelectedRegion != null) {
                loadRegionHealthChart(currentSelectedPlanet, currentSelectedRegion, timeRange);
            }
            
            // é‡æ–°åŠ è½½åœ°åŒºå†å²æ•°æ®
            if (typeof currentSelectedPlanet !== 'undefined' && currentSelectedRegion != null) {
                loadRegionHistoryData(currentSelectedPlanet);
            }
        }

        function displayOrdersList(orders) {
            const container = document.getElementById('ordersList');
            
            if (!orders || orders.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— æ´»è·ƒè®¢å•</div>';
                return;
            }
            
            let html = '';
            
            orders.forEach(order => {
                const isActive = order.is_active;
                const statusClass = isActive ? 'order-status-active' : 'order-status-expired';
                const statusText = isActive ? 'è¿›è¡Œä¸­' : 'å·²è¿‡æœŸ';
                const timeRemaining = isActive ? `${Math.floor(order.expires_in / 3600)}å°æ—¶` : 'å·²ç»“æŸ';
                
                html += `
                    <div class="order-item" onclick="selectOrder(${order.order_id})">
                        <span class="${statusClass}">${statusText}</span>
                        <div class="order-title">${order.title || 'æœªçŸ¥è®¢å•'}</div>
                        <div class="order-progress-info">
                            è¿›åº¦: ${formatNumber(order.current_progress)}/${formatNumber(order.target_value)} 
                            (${order.progress_percentage.toFixed(1)}%)
                        </div>
                        <div class="health-bar">
                            <div class="health-fill" style="width: ${order.progress_percentage}%"></div>
                        </div>
                        <div class="order-brief">${order.brief || 'æš‚æ— æè¿°'}</div>
                        <div class="order-meta">
                            <span>å‰©ä½™: ${timeRemaining}</span>
                            <span>æ´»è·ƒ: ${order.duration_hours.toFixed(1)}å°æ—¶</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateOrdersOverview(orders) {
            if (!orders || orders.length === 0) return;
            
            const activeOrders = orders.filter(order => order.is_active);
            
            if (allChartsData.majorOrdersOverviewChart) {
                allChartsData.majorOrdersOverviewChart.data.labels = activeOrders.map(order => 
                    order.title && order.title.length > 15 ? order.title.substring(0, 15) + '...' : (order.title || 'æœªçŸ¥è®¢å•')
                );
                allChartsData.majorOrdersOverviewChart.data.datasets[0].data = activeOrders.map(order => 
                    order.progress_percentage
                );
                allChartsData.majorOrdersOverviewChart.update('none');
            }
        }

        function updateOrdersTimeline(orders) {
            const timeline = document.getElementById('ordersTimeline');
            
            if (!orders || orders.length === 0) {
                timeline.innerHTML = '<div class="loading">æš‚æ— è®¢å•æ•°æ®</div>';
                return;
            }
            
            let html = '';
            
            orders.forEach(order => {
                const progressPercent = order.progress_percentage || 0;
                const isActive = order.is_active;
                const statusColor = isActive ? '#4CAF50' : '#f44336';
                
                html += `
                    <div class="stat-card" style="text-align: left; margin-bottom: 15px; border-left-color: ${statusColor};">
                        <div class="stat-label" style="font-size: 1rem; margin-bottom: 10px;">
                            ${order.title || 'æœªçŸ¥è®¢å•'}
                            <span style="float: right; color: ${statusColor}; font-size: 0.8rem;">
                                ${isActive ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ'}
                            </span>
                        </div>
                        <div style="margin-bottom: 10px; font-size: 0.9rem;">${order.brief || 'æš‚æ— æè¿°'}</div>
                        <div class="health-bar">
                            <div class="health-fill" style="width: ${progressPercent}%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-top: 8px;">
                            <span>è¿›åº¦: ${formatNumber(order.current_progress)}/${formatNumber(order.target_value)} (${progressPercent.toFixed(1)}%)</span>
                            <span>${isActive ? `å‰©ä½™: ${Math.floor(order.expires_in / 3600)}å°æ—¶` : 'å·²ç»“æŸ'}</span>
                        </div>
                    </div>
                `;
            });
            
            timeline.innerHTML = html;
        }

        function selectOrder(orderId) {
            document.querySelectorAll('.order-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            event.target.closest('.order-item').classList.add('selected');
            
            currentSelectedOrder = orderId;
            
            const timeRange = document.getElementById('ordersTimeRange')?.value || 48;
            displayOrderDetails(orderId, timeRange);
        }

        async function displayOrderDetails(orderId, timeRange = 48) {
            try {
                const response = await fetch(`/api/major-order-progress-history/${orderId}?hours=${timeRange}&limit=100`);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('orderDetails').innerHTML = 
                        '<div class="error">è®¢å•è¯¦æƒ…åŠ è½½å¤±è´¥</div>';
                    return;
                }
                
                const orderInfo = data.order_info;
                const progressHistory = data.progress_history;
                
                const container = document.getElementById('orderDetails');
                
                const currentProgress = progressHistory.length > 0 ? progressHistory[progressHistory.length - 1] : null;
                const startProgress = progressHistory.length > 0 ? progressHistory[0] : null;
                const progressGain = currentProgress && startProgress ? 
                    currentProgress.current_progress - startProgress.current_progress : 0;
                const timeSpan = currentProgress && startProgress ? 
                    (currentProgress.timestamp - startProgress.timestamp) / 3600 : 0;
                const avgProgressPerHour = timeSpan > 0 ? progressGain / timeSpan : 0;
                
                let html = `
                    <h3>${orderInfo.title || 'æœªçŸ¥è®¢å•'}</h3>
                    <div class="order-stats">
                        <div class="order-stat">
                            <div class="stat-value">${currentProgress ? formatNumber(currentProgress.current_progress) : 'æœªçŸ¥'}</div>
                            <div class="stat-label">å½“å‰è¿›åº¦</div>
                        </div>
                        <div class="order-stat">
                            <div class="stat-value">${formatNumber(orderInfo.target_value)}</div>
                            <div class="stat-label">ç›®æ ‡å€¼</div>
                        </div>
                        <div class="order-stat">
                            <div class="stat-value">${currentProgress ? currentProgress.progress_percentage.toFixed(1) : '0'}%</div>
                            <div class="stat-label">å®Œæˆç™¾åˆ†æ¯”</div>
                        </div>
                        <div class="order-stat">
                            <div class="stat-value">${formatNumber(progressGain)}</div>
                            <div class="stat-label">${timeRange}hå†…å¢é•¿</div>
                        </div>
                        <div class="order-stat">
                            <div class="stat-value">${avgProgressPerHour > 0 ? formatNumber(avgProgressPerHour) : '0'}</div>
                            <div class="stat-label">å¹³å‡æ¯å°æ—¶</div>
                        </div>
                        <div class="order-stat">
                            <div class="stat-value">${currentProgress ? Math.floor(currentProgress.expires_in / 3600) : '0'}</div>
                            <div class="stat-label">å‰©ä½™å°æ—¶</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px; padding: 15px; background-color: #3a3a3a; border-radius: 8px;">
                        <strong>è®¢å•æè¿°:</strong><br>
                        ${orderInfo.brief || 'æš‚æ— æè¿°'}
                    </div>
                `;
                
                if (progressHistory.length > 0) {
                    html += `
                        <div class="progress-chart-container">
                            <div class="progress-chart-title">è¿›åº¦å˜åŒ–æ›²çº¿ (${timeRange}å°æ—¶)</div>
                            <div class="progress-chart-wrapper">
                                <canvas id="orderProgressChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                
                if (progressHistory.length > 0) {
                    createOrderProgressChart(progressHistory, orderInfo);
                }
                
            } catch (error) {
                console.error('è·å–è®¢å•è¯¦æƒ…å¤±è´¥:', error);
                document.getElementById('orderDetails').innerHTML = 
                    '<div class="error">è®¢å•è¯¦æƒ…åŠ è½½å¤±è´¥</div>';
            }
        }

        function createOrderProgressChart(progressHistory, orderInfo) {
            const ctx = document.getElementById('orderProgressChart').getContext('2d');
            
            if (allChartsData.orderProgressChart) {
                allChartsData.orderProgressChart.destroy();
            }
            
            const labels = progressHistory.map(d => formatTimestamp(d.timestamp));
            const progressData = progressHistory.map(d => d.current_progress);
            const percentageData = progressHistory.map(d => d.progress_percentage);
            
            allChartsData.orderProgressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ç»å¯¹è¿›åº¦',
                            data: progressData,
                            borderColor: '#ffdd44',
                            backgroundColor: 'rgba(255, 221, 68, 0.1)',
                            tension: 0.1,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'å®Œæˆç™¾åˆ†æ¯”',
                            data: percentageData,
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.1,
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 300
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff',
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 0) {
                                        const percentage = percentageData[context.dataIndex];
                                        return `å®Œæˆåº¦: ${percentage.toFixed(1)}%`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { 
                                color: '#ffffff',
                                font: { size: 10 },
                                maxTicksLimit: 10
                            },
                            grid: { color: '#444' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: { 
                                color: '#ffffff',
                                font: { size: 10 },
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            },
                            grid: { color: '#444' },
                            title: {
                                display: true,
                                text: 'ç»å¯¹è¿›åº¦',
                                color: '#ffdd44'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            ticks: { 
                                color: '#ffffff',
                                font: { size: 10 },
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: { drawOnChartArea: false, color: '#444' },
                            title: {
                                display: true,
                                text: 'å®Œæˆç™¾åˆ†æ¯”',
                                color: '#4CAF50'
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 3,
                            hoverRadius: 5
                        }
                    }
                }
            });
        }
        
        // æ˜Ÿçƒç›¸å…³å‡½æ•°ï¼ˆæ”¹è¿›ç‰ˆï¼Œä½¿ç”¨çœŸå®è®¡ç®—ï¼‰
        async function loadPlanetsData() {
            try {
                const response = await fetch('/api/planets-by-sector');
                const data = await response.json();
                currentPlanetData = data;
                
                // åŠ è½½å†å²æ•°æ®ç”¨äºè®¡ç®—çœŸå®å˜åŒ–ç‡
                await loadPlanetHistoryData();
                
                displayPlanetsList(data);
            } catch (error) {
                console.error('è·å–æ˜Ÿçƒæ•°æ®å¤±è´¥:', error);
                document.getElementById('planetsListing').innerHTML = 
                    '<div class="error">æ˜Ÿçƒæ•°æ®åŠ è½½å¤±è´¥</div>';
            }
        }

        async function loadPlanetHistoryData() {
            try {
                const promises = [];
                
                // è·å–æ˜Ÿçƒå†å²æ•°æ®
                if (currentPlanetData && currentPlanetData.sectors) {
                    Object.values(currentPlanetData.sectors).forEach(planets => {
                        planets.forEach(planet => {
                            promises.push(fetchPlanetDataWithRetry(planet.index));
                        });
                    });
                }
                
                // ä½¿ç”¨ allSettled ç¡®ä¿æ‰€æœ‰è¯·æ±‚éƒ½å®Œæˆï¼ˆæ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼‰
                const results = await Promise.allSettled(promises);
                
                // æ£€æŸ¥ç»“æœ
                const failedPlanets = [];
                results.forEach((result, index) => {
                    if (result.status === 'rejected') {
                        failedPlanets.push(index);
                    }
                });
                
                if (failedPlanets.length > 0) {
                    console.log(`${failedPlanets.length} ä¸ªæ˜Ÿçƒæ•°æ®è·å–å¤±è´¥ï¼Œå¯ä»¥é€‰æ‹©é‡æ–°å°è¯•`);
                }
                
            } catch (error) {
                console.error('è·å–å†å²æ•°æ®å¤±è´¥:', error);
            }
        }
        
        async function fetchPlanetDataWithRetry(planetIndex, maxRetries = 3) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(`/api/planet-health-history/${planetIndex}?hours=6&limit=10`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    planetHistoryData[planetIndex] = data;
                    return data;
                    
                } catch (error) {
                    if (attempt === maxRetries) {
                        throw new Error(`æ˜Ÿçƒ ${planetIndex} åœ¨${maxRetries}æ¬¡å°è¯•åä»ç„¶å¤±è´¥: ${error.message}`);
                    }
                    
                    // æŒ‡æ•°é€€é¿å»¶è¿Ÿ
                    const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function displayPlanetsList(data) {
            const container = document.getElementById('planetsListing');
            
            if (!data.sectors) {
                container.innerHTML = '<div class="error">æ˜Ÿçƒæ•°æ®æ ¼å¼é”™è¯¯</div>';
                return;
            }
            
            let html = '';
            
            const sortedSectors = Object.keys(data.sectors).sort((a, b) => parseInt(a) - parseInt(b));
            
            sortedSectors.forEach(sectorId => {
                //if (sectorId > 0) return;
                const planets = data.sectors[sectorId];
                if (planets.length > 0) {
                    const planetsByOwner = {
                        1: [],
                        2: [],
                        3: [],
                        4: []
                    };
                    
                    planets.forEach(planet => {
                        planetsByOwner[planet.owner].push(planet);
                    });
                    
                    html += `
                        <div class="sector-group">
                            <div class="sector-header">
                                Sector ${sectorId} (${planets.length}ä¸ªæ˜Ÿçƒ)
                            </div>
                    `;
                    
                    Object.keys(planetsByOwner).forEach(owner => {
                        const ownerPlanets = planetsByOwner[owner];
                        if (ownerPlanets.length > 0) {
                            ownerPlanets.forEach(planet => {
                                const healthPercent = (planet.health / planet.max_health * 100).toFixed(1);
                                
                                // è®¡ç®—çœŸå®å é¢†åº¦å˜åŒ–
                                const controlChange = calculateRealControlChange(planet.health, planet.max_health, planet.index, planet.owner);
                                const battleStatus = analyzeRealBattleStatus(planet, controlChange, planet.owner);
                                
                                let statusIndicator = 'stable';
                                let trendClass = 'trend-neutral';
                                let trendText = 'æœªäº¤æˆ˜';
                                
                                if (planet.owner !== 1 && planet.health == planet.max_health) {
                                    statusIndicator = 'enemy-controlled';
                                    trendClass = 'trend-enemy';
                                    trendText = 'æ•Œæ–¹æ§åˆ¶';
                                } else if (battleStatus.status === 'critical') {
                                    statusIndicator = 'critical';
                                    trendClass = 'trend-negative';
                                    trendText = 'å±æ€¥å¤±å®ˆ';
                                } else if (battleStatus.status === 'under-fierce-attack') {
                                    statusIndicator = 'under-fierce-attack';
                                    trendClass = 'trend-negative';
                                    trendText = 'æ¿€æˆ˜ä¸­';
                                } else if (battleStatus.status === 'gaining') {
                                    statusIndicator = 'gaining';
                                    trendClass = 'trend-positive';
                                    trendText = 'æ”¶å¤ä¸­';
                                } else if (battleStatus.status === 'losing') {
                                    statusIndicator = 'losing';
                                    trendClass = 'trend-negative';
                                    trendText = 'å¤±å®ˆä¸­';
                                }
                                
                                const criticalClass = battleStatus.status === 'critical' && planet.owner === 1 ? 'critical' : '';
                                
                                html += `
                                    <div class="planet-item owner-${planet.owner} ${criticalClass}" onclick="selectPlanet(${planet.index})">
                                        <div class="planet-status-indicator ${statusIndicator}"></div>
                                        <div class="planet-name">
                                            <span>æ˜Ÿçƒ #${planet.index}</span>
                                            <span class="planet-owner-indicator owner-${planet.owner}"></span>
                                        </div>
                                        <div class="planet-info">
                                            ${getFactionName(planet.owner)} | æ§åˆ¶åº¦: ${controlChange.currentControl.toFixed(1)}% | ç©å®¶: ${planet.players}
                                        </div>
                                        <div class="planet-trend ${trendClass}">
                                            ${battleStatus.description} | ${trendText}
                                        </div>
                                    </div>
                                `;
                            });
                        }
                    });
                    
                    html += '</div>';
                }
            });
            
            container.innerHTML = html;
        }

        function selectPlanet(planetIndex) {
            document.querySelectorAll('.planet-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            event.target.closest('.planet-item').classList.add('selected');
            
            currentSelectedPlanet = planetIndex;
            
            displayPlanetDetails(planetIndex);
        }

        async function displayPlanetDetails(planetIndex) {
            try {
                const response = await fetch(`/api/planet-details/${planetIndex}`);
                const planetData = await response.json();
                
                const container = document.getElementById('planetDetails');
                
                // è®¡ç®—çœŸå®çš„æ˜Ÿçƒæ§åˆ¶æ•°æ®
                const controlChange = calculateRealControlChange(planetData.planet.health, planetData.planet.max_health, planetIndex, planetData.planet.owner);
                const battleStatus = analyzeRealBattleStatus(planetData.planet, controlChange, planetData.planet.owner);
                
                // è®¡ç®—åœ°åŒºç»Ÿè®¡æ•°æ®
                const regionStats = calculateRealRegionStats(planetData.regions, planetIndex);
                
                let html = `
                    <h3>æ˜Ÿçƒ #${planetIndex} è¯¦æƒ… (Sector ${planetData.planet.sector})</h3>
                    
                    <!-- API ä¿¡æ¯é¢æ¿ -->
                    <div class="api-info">
                        <h4>API æä¾›çš„åŸå§‹æ•°æ®</h4>
                        <div class="api-grid">
                            <div class="api-item">
                                <span class="api-label">å½“å‰ç”Ÿå‘½å€¼:</span> ${formatNumber(planetData.planet.health)}
                            </div>
                            <div class="api-item">
                                <span class="api-label">æœ€å¤§ç”Ÿå‘½å€¼:</span> ${formatNumber(planetData.planet.max_health)}
                            </div>
                            <div class="api-item">
                                <span class="api-label">ä½ç½®åæ ‡:</span> (${planetData.planet.position.x.toFixed(2)}, ${planetData.planet.position.y.toFixed(2)})
                            </div>
                            <div class="api-item">
                                <span class="api-label">åœ¨çº¿ç©å®¶:</span> ${planetData.planet.players}
                            </div>
                        </div>
                    </div>
                    
                    <!-- çœŸå®æˆ˜å†µåˆ†æ -->
                    <div class="battle-summary">
                        <h4>çœŸå®æˆ˜å†µåˆ†æ</h4>
                        <div class="battle-indicators">
                            <div class="battle-indicator ${battleStatus.isEnemyControlled ? 'enemy' : battleStatus.status === 'critical' ? 'critical' : 'stable'}">
                                <div class="stat-value" style="color: ${battleStatus.color};">${battleStatus.description}</div>
                                <div class="stat-label">å½“å‰çŠ¶æ€</div>
                            </div>
                            <!--
                            <div class="battle-indicator">
                                <div class="stat-value">${controlChange.currentControl.toFixed(1)}%</div>
                                <div class="stat-label">çœŸå®æ§åˆ¶åº¦</div>
                            </div>
                            <div class="battle-indicator">
                                <div class="stat-value ${controlChange.changeRate > 0 ? 'positive' : controlChange.changeRate < 0 ? 'negative' : 'neutral'}">${controlChange.changeRate.toFixed(2)}%/h</div>
                                <div class="stat-label">æ§åˆ¶åº¦å˜åŒ–ç‡</div>
                            </div>
                             -->
                            <div class="battle-indicator">
                                <div class="stat-value">${regionStats.contestedRegions}</div>
                                <div class="stat-label">æ¿€æˆ˜åœ°åŒº</div>
                            </div>
                            <div class="battle-indicator">
                                <div class="stat-value">${regionStats.enemyControlledRegions}</div>
                                <div class="stat-label">æ•Œæ§åœ°åŒº</div>
                            </div>
                            <div class="battle-indicator">
                                <div class="stat-value">${regionStats.criticalRegions}</div>
                                <div class="stat-label">å±æ€¥åœ°åŒº</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="planet-stats">
                        <div class="planet-stat ${battleStatus.isEnemyControlled ? 'enemy' : ''}">
                            <div class="stat-value">${getFactionName(planetData.planet.owner)}</div>
                            <div class="stat-label">æ§åˆ¶æ–¹</div>
                        </div>
                        <div class="planet-stat region-card ${controlChange.currentControl < 30 && controlChange.currentControl >= 0 ? 'critical' : controlChange.currentControl > 70 ? 'positive' : ''}" onclick="currentSelectedRegion=-1;loadRegionHealthChart(${planetIndex}, -1);document.getElementById('regionCharts').classList.add('active');">
                            <div class="stat-value">${controlChange.currentControl.toFixed(1)}%</div>
                            <div class="stat-label">çœŸå®æ§åˆ¶åº¦</div>
                        </div>
                        <div class="planet-stat">
                            <div class="stat-value">${planetData.planet.players}</div>
                            <div class="stat-label">å½“å‰ç©å®¶</div>
                        </div>
                        <div class="planet-stat region-card ${controlChange.changeRate < 0 ? 'critical' : 'positive'}" onclick="currentSelectedRegion=-1;loadRegionHealthChart(${planetIndex}, -1);document.getElementById('regionCharts').classList.add('active');">
                            <div class="stat-value">${controlChange.changeRate.toFixed(2)}%/h</div>
                            <div class="stat-label">å˜åŒ–ç‡</div>
                        </div>
                        <div class="planet-stat">
                            <div class="stat-value">${regionStats.activeRegions}</div>
                            <div class="stat-label">æ´»è·ƒåœ°åŒº</div>
                        </div>
                        <div class="planet-stat">
                            <div class="stat-value">${controlChange.changeRate > 0 ? (((planetData.planet.owner===1?100:0) - controlChange.currentControl) / controlChange.changeRate).toFixed(2) : controlChange.changeRate < 0 ?(((planetData.planet.owner===1?0:-100) - controlChange.currentControl) / controlChange.changeRate).toFixed(2) : '-'}h</div>
                            <div class="stat-label">å®Œå…¨æ²¦é™·/å é¢†</div>
                        </div>
                    </div>
                    
                    <h4 style="color: #ffdd44; margin-bottom: 15px;">åœ°åŒºè¯¦æƒ… (ç‚¹å‡»æŸ¥çœ‹çœŸå®æ•°æ®åˆ†æ)</h4>
                    <div class="regions-grid">
                `;
                
                planetData.regions.forEach(region => {
                    // è®¡ç®—åœ°åŒºçœŸå®æ•°æ®
                    const regionControlChange = calculateRealControlChange(region.health, region.maxHealth, planetIndex, region.owner, region.regionIndex);
                    const regionBattleStatus = analyzeRealBattleStatus(region, regionControlChange, region.owner);
                    
                    const ownerClass = `owner-${region.owner}`;
                    // ä¿®æ”¹åœ°åŒºå¡ç‰‡HTMLç”Ÿæˆéƒ¨åˆ†çš„statusClassåˆ¤æ–­
                    const statusClass = regionBattleStatus.isEnemyControlled ? 'enemy-controlled' : 
                                       regionBattleStatus.status === 'critical' ? 'critical' :
                                       regionBattleStatus.status === 'under-fierce-attack' ? 'under-fierce-attack' :
                                       regionBattleStatus.status === 'losing' ? 'losing' : 
                                       regionBattleStatus.status === 'gaining' ? 'gaining' :
                                       regionBattleStatus.status === 'stable' ? 'stable' : 
                                       regionBattleStatus.status === 'contested' ? 'contested' : '';
                    
                    html += `
                        <div class="region-card ${ownerClass} ${statusClass}" onclick="selectRegion(${planetIndex}, ${region.regionIndex})">
                            <div class="region-header">
                                <span>åœ°åŒº #${region.regionIndex}</span>
                                <span class="region-status ${statusClass}">${regionBattleStatus.description}</span>
                            </div>
                            <div>æ§åˆ¶æ–¹: ${getFactionName(region.owner)}</div>
                            <div class="health-bar">
                                <div class="health-fill ${regionBattleStatus.isEnemyControlled ? 'enemy' : ''}" style="width: ${regionControlChange.currentControl}%"></div>
                            </div>
                            <div class="region-metrics">
                                <div class="metric">
                                    <span>çœŸå®æ§åˆ¶åº¦:</span>
                                    <span class="metric-value ${regionBattleStatus.isEnemyControlled ? 'enemy' : regionControlChange.currentControl > 30 ? 'positive' : 'negative'}">${regionControlChange.currentControl.toFixed(1)}%</span>
                                </div>
                                <div class="metric">
                                    <span>å˜åŒ–ç‡:</span>
                                    <span class="metric-value ${regionControlChange.changeRate > 0 ? 'positive' : regionControlChange.changeRate < 0 ? 'negative' : 'neutral'}">(${(regionControlChange.changeRate-3600*region.regerPerSecond/region.maxHealth*100).toFixed(2)} - ${(-3600*region.regerPerSecond/region.maxHealth*100).toFixed(2)})${regionControlChange.changeRate.toFixed(2)}%/h</span>
                                </div>
                                <div class="metric">
                                    <span>ç©å®¶æ•°:</span>
                                    <span class="metric-value ${region.players > 0 ? 'positive' : 'neutral'}">${region.players}</span>
                                </div>
                                <div class="metric">
                                    <span>æ²¦é™·/å®Œå…¨å é¢†:</span>
                                    <span class="metric-value">${regionControlChange.changeRate > 0 ? (((region.owner===1?100:0) - regionControlChange.currentControl) / regionControlChange.changeRate).toFixed(2) : regionControlChange.changeRate < 0 ?( ((region.owner===1?0:-100) - regionControlChange.currentControl) / regionControlChange.changeRate).toFixed(2) : '-'}h</span>
                                </div>
                                <div class="metric">
                                    <span>ä¼˜å…ˆçº§:</span>
                                    <span class="metric-value ${regionBattleStatus.priority >= 4 ? 'negative' : 'neutral'}">${regionBattleStatus.priority}/5</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
                // åŠ è½½åœ°åŒºå†å²æ•°æ®ç”¨äºå›¾è¡¨
                await loadRegionHistoryData(planetIndex);
                
            } catch (error) {
                console.error('è·å–æ˜Ÿçƒè¯¦æƒ…å¤±è´¥:', error);
                document.getElementById('planetDetails').innerHTML = 
                    '<div class="error">æ˜Ÿçƒè¯¦æƒ…åŠ è½½å¤±è´¥</div>';
            }
        }

        async function loadRegionHistoryData(planetIndex) {
            try {
                const planetData = currentPlanetData.sectors;
                let targetPlanet = null;
                
                // æ‰¾åˆ°ç›®æ ‡æ˜Ÿçƒ
                Object.values(planetData).forEach(planets => {
                    planets.forEach(planet => {
                        if (planet.index === planetIndex) {
                            targetPlanet = planet;
                        }
                    });
                });
                
                if (targetPlanet == null) return;
                
                // è·å–æ˜Ÿçƒè¯¦æƒ…ä»¥è·å–åœ°åŒºä¿¡æ¯
                const response = await fetch(`/api/planet-details/${planetIndex}`);
                const planetDetails = await response.json();
                
                // ä¸ºæ¯ä¸ªåœ°åŒºè·å–å†å²æ•°æ®
                const promises = planetDetails.regions.map(region => 
                    fetch(`/api/region-health-history/${planetIndex}/${region.regionIndex}?hours=6&limit=10`)
                        .then(response => response.json())
                        .then(data => {
                            planetHistoryData[`${planetIndex}_${region.regionIndex}`] = data;
                        })
                        .catch(error => console.error(`è·å–åœ°åŒº ${planetIndex}_${region.regionIndex} å†å²æ•°æ®å¤±è´¥:`, error))
                );
                
                await Promise.all(promises);
            } catch (error) {
                console.error('è·å–åœ°åŒºå†å²æ•°æ®å¤±è´¥:', error);
            }
        }

        function calculateRealRegionStats(regions, planetIndex) {
            let contestedRegions = 0;
            let criticalRegions = 0;
            let activeRegions = 0;
            let enemyControlledRegions = 0;
            let totalPlayers = 0;
            
            regions.forEach(region => {
                totalPlayers += region.players;
                
                if (region.players > 0) activeRegions++;
                if (region.owner !== 1) enemyControlledRegions++;
                
                // åŸºäºçœŸå®æ•°æ®è®¡ç®—
                const controlChange = calculateRealControlChange(region.health, region.maxHealth, planetIndex, region.owner, region.regionIndex);
                const battleStatus = analyzeRealBattleStatus(region, controlChange, region.owner);
                
                if (battleStatus.status === 'critical') criticalRegions++;
                if (Math.abs(controlChange.changeRate) > 3) contestedRegions++;
            });
            
            return {
                contestedRegions: contestedRegions,
                criticalRegions: criticalRegions,
                activeRegions: activeRegions,
                enemyControlledRegions: enemyControlledRegions,
                totalPlayers: totalPlayers
            };
        }

        async function selectRegion(planetIndex, regionIndex) {
            document.querySelectorAll('.region-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.target.closest('.region-card').classList.add('selected');
            
            currentSelectedRegion = regionIndex;
            
            await loadRegionHealthChart(planetIndex, regionIndex);
            document.getElementById('regionCharts').classList.add('active');
        }

        async function loadRegionHealthChart(planetIndex, regionIndex, timeRange = document.getElementById('regionTimeRange')?.value || 24) {
            try {
                const url = regionIndex===-1?`/api/planet-health-history/${planetIndex}?hours=${timeRange}&limit=1000`:`/api/region-health-history/${planetIndex}/${regionIndex}?hours=${timeRange}&limit=1000`;
                const response = await fetch(url);
                const healthData = await response.json();
                
                if (healthData.length > 0) {
                    const labels = healthData.map(d => formatTimestamp(d.timestamp));
                    
                    // è®¡ç®—çœŸå®å é¢†åº¦æ•°æ®
                    const controlData = [];
                    const controlChangeRates = [];
                    //const maxHealth = healthData[0] ? (healthData.find(d => d.health > 0)?.health * 2 || 600000) : 600000; // ä¼°ç®—æœ€å¤§ç”Ÿå‘½å€¼
                    const res = await fetch(`/api/planet-details/${planetIndex}`);
                    const maxHealthData = await res.json();
                    const maxHealth = regionIndex===-1?maxHealthData.planet.max_health:maxHealthData.regions[regionIndex].maxHealth;
                    
                    healthData.forEach((dataPoint, index) => {
                        const control = ((dataPoint.owner!==1?-dataPoint.health:dataPoint.health) / maxHealth) * 100;
                        //controlData.push(Math.min(100, Math.max(0, control)));
                        controlData.push(control);
                        
                        if (index > 0) {
                            const prevControl = ((healthData[index - 1].owner!==1?-healthData[index - 1].health:healthData[index - 1].health) / maxHealth) * 100;
                            const timeDiff = (dataPoint.timestamp - healthData[index - 1].timestamp) / 3600; // å°æ—¶
                            const changeRate = timeDiff > 0 ? (control - prevControl) / timeDiff : 0;
                            controlChangeRates.push(changeRate);
                        } else {
                            controlChangeRates.push(null);
                        }
                    });
                    
                    // æ›´æ–°ç”Ÿå‘½å€¼å›¾è¡¨
                    allChartsData.regionHealthChart.data.labels = labels;
                    allChartsData.regionHealthChart.data.datasets[0].data = healthData.map(d => d.owner!==1?-d.health:d.health);
                    allChartsData.regionHealthChart.data.datasets[1].data = healthData.map(d => d.players);
                    
                    // æ›´æ–°çœŸå®æ§åˆ¶åº¦å›¾è¡¨
                    allChartsData.regionControlChart.data.labels = labels;
                    allChartsData.regionControlChart.data.datasets[0].data = controlData;
                    allChartsData.regionControlChart.data.datasets[1].data = controlChangeRates;
                    
                    // æ›´æ–°å›¾è¡¨æ ‡é¢˜
                    document.querySelector('#regionCharts .chart-title').textContent = 
                        regionIndex === -1 ? 
                        `æ˜Ÿçƒ #${planetIndex} - ç”Ÿå‘½å€¼ä¸ç©å®¶åˆ†æ` : 
                        `æ˜Ÿçƒ #${planetIndex} åœ°åŒº #${regionIndex} - ç”Ÿå‘½å€¼ä¸ç©å®¶åˆ†æ`;
                    
                    allChartsData.regionHealthChart.update('none');
                    allChartsData.regionControlChart.update('none');
                }
            } catch (error) {
                console.error('åŠ è½½åœ°åŒºåˆ†æå›¾è¡¨å¤±è´¥:', error);
            }
        }
        
        // æ–°é—»åŠŸèƒ½å‡½æ•°
        async function loadNewsData(reset = false) {
            if (newsIsLoading) return;
            
            if (reset) {
                newsCurrentPage = 0;
                newsData = [];
                newsHasMore = true;
                document.getElementById('newsFeed').innerHTML = '<div class="news-loading">ğŸ“¡ æ­£åœ¨è·å–æœ€æ–°æˆ˜äº‰æƒ…æŠ¥...</div>';
            }
            
            newsIsLoading = true;
            
            try {
                const params = new URLSearchParams({
                    limit: newsPageSize,
                    offset: newsCurrentPage * newsPageSize
                });
                
                if (newsCurrentFilter) {
                    params.append('type', newsCurrentFilter);
                }
                
                const response = await fetch(`/api/news?${params}`);
                const data = await response.json();
                
                if (data.news && data.news.length > 0) {
                    newsData = reset ? data.news : [...newsData, ...data.news];
                    newsHasMore = data.has_more;
                    newsCurrentPage++;
                    
                    displayNewsFeed();
                    updateNewsStats(data.total_count);
                } else {
                    newsHasMore = false;
                    if (newsData.length === 0) {
                        document.getElementById('newsFeed').innerHTML = '<div class="news-empty">ğŸ“­ æš‚æ— æ–°é—»æ•°æ®</div>';
                    }
                }
                
            } catch (error) {
                console.error('è·å–æ–°é—»æ•°æ®å¤±è´¥:', error);
                document.getElementById('newsFeed').innerHTML = '<div class="news-error">âŒ æ–°é—»åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            } finally {
                newsIsLoading = false;
            }
        }
        
        function displayNewsFeed() {
            const container = document.getElementById('newsFeed');
            
            if (newsData.length === 0) {
                container.innerHTML = '<div class="news-empty">ğŸ“­ æš‚æ— æ–°é—»æ•°æ®</div>';
                return;
            }
            
            let html = '';
            
            newsData.forEach(news => {
                const isBreaking = isNewsBreaking(news);
                const formattedContent = formatNewsContent(news.message);
                const timeAgo = getTimeAgo(news.published);
                
                html += `
                    <div class="news-item type-${news.type} ${isBreaking ? 'breaking' : ''}" data-news-id="${news.id}">
                        <div class="news-meta">
                            <div class="news-timestamp">
                                <span>ğŸ• ${timeAgo}</span>
                                <span style="margin-left: 10px; opacity: 0.7;">${formatTimestamp(news.published)}</span>
                            </div>
                            <div class="news-type-badge type-${news.type}">
                                ${getNewsTypeName(news.type)}
                            </div>
                        </div>
                        
                        <div class="news-content">
                            ${formattedContent}
                        </div>
                        
                        ${news.tagIds && news.tagIds.length > 0 ? `
                            <div class="news-tags">
                                ${news.tagIds.map(tag => `<span class="news-tag">#${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            // æ·»åŠ åŠ è½½æ›´å¤šæˆ–ç»“æŸæç¤º
            if (newsHasMore) {
                html += '<div class="news-loading-more" id="newsLoadingMore">æ­£åœ¨åŠ è½½æ›´å¤šæ–°é—»...</div>';
            } else if (newsData.length > 0) {
                html += '<div class="news-end-message active">ğŸ“œ å·²æ˜¾ç¤ºæ‰€æœ‰æ–°é—»</div>';
            }
            
            container.innerHTML = html;
            
            // è®¾ç½®æ»šåŠ¨ç›‘å¬
            setupNewsScrollListener();
        }
        
        function setupNewsScrollListener() {
            const container = document.getElementById('newsFeed');
            
            container.removeEventListener('scroll', handleNewsScroll);
            container.addEventListener('scroll', handleNewsScroll);
        }
        
        function handleNewsScroll() {
            if (newsIsLoading || !newsHasMore) return;
            
            const container = document.getElementById('newsFeed');
            const scrollPosition = container.scrollTop + container.clientHeight;
            const scrollHeight = container.scrollHeight;
            
            // å½“æ»šåŠ¨åˆ°åº•éƒ¨80%æ—¶å¼€å§‹åŠ è½½
            if (scrollPosition >= scrollHeight * 0.8) {
                const loadingMore = document.getElementById('newsLoadingMore');
                if (loadingMore) {
                    loadingMore.classList.add('active');
                }
                loadNewsData(false);
            }
        }
        
        function formatNewsContent(content) {
            if (!content) return '<em>æš‚æ— å†…å®¹</em>';
            
            // å¤„ç†ç‰¹æ®Šæ ¼å¼æ ‡è®°
            let formattedContent = content
                .replace(/<i=1>(.*?)<\/i>/g, '<span style="color: #4CAF50; font-weight: bold;">$1</span>')
                .replace(/<i=3>(.*?)<\/i>/g, '<span style="color: #f44336; font-weight: bold; text-transform: uppercase;">$1</span>')
                .replace(/\n/g, '<br>');
            
            // å°†å†…å®¹åˆ†æ®µ
            const paragraphs = formattedContent.split('<br><br>');
            return paragraphs.map(p => `<p>${p}</p>`).join('');
        }
        
        function getNewsTypeName(type) {
            const types = {
                0: 'å¸¸è§„',
                1: 'é‡è¦',
                2: 'æˆ˜å†µ',
                3: 'è­¦æŠ¥'
            };
            return types[type] || 'æœªçŸ¥';
        }
        
        function isNewsBreaking(news) {
            // åˆ¤æ–­æ–°é—»æ˜¯å¦ä¸ºçªå‘æ–°é—»ï¼ˆæœ€è¿‘2å°æ—¶å†…å‘å¸ƒçš„é‡è¦æ–°é—»ï¼‰
            const now = Date.now() / 1000;
            const twoHoursAgo = now - (2 * 3600);
            
            return news.type >= 2 && news.published > twoHoursAgo;
        }
        
        function getTimeAgo(timestamp) {
            const now = Date.now() / 1000;
            const diff = now - timestamp;
            
            if (diff < 3600) {
                const minutes = Math.floor(diff / 60);
                return `${minutes}åˆ†é’Ÿå‰`;
            } else if (diff < 86400) {
                const hours = Math.floor(diff / 3600);
                return `${hours}å°æ—¶å‰`;
            } else {
                const days = Math.floor(diff / 86400);
                return `${days}å¤©å‰`;
            }
        }
        
        async function updateNewsStats(totalCount = null) {
            try {
                if (totalCount === null) {
                    const response = await fetch('/api/news/stats');
                    newsStats = await response.json();
                } else {
                    newsStats.total_count = totalCount;
                }
                
                const statsElement = document.getElementById('newsStats');
                if (statsElement) {
                    statsElement.innerHTML = `
                        å…± ${newsStats.total_count || 0} æ¡æ–°é—»
                        ${newsStats.recent_24h_count ? `(24hå†…æ–°å¢ ${newsStats.recent_24h_count} æ¡)` : ''}
                    `;
                }
                
            } catch (error) {
                console.error('è·å–æ–°é—»ç»Ÿè®¡å¤±è´¥:', error);
            }
        }
        
        function filterNewsByType() {
            const filterSelect = document.getElementById('newsTypeFilter');
            newsCurrentFilter = filterSelect.value;
            loadNewsData(true);
        }
        
        function refreshNews() {
            const refreshBtn = document.getElementById('refreshNewsBtn');
            refreshBtn.innerHTML = 'ğŸ”„ åˆ·æ–°ä¸­...';
            refreshBtn.disabled = true;
            
            loadNewsData(true).finally(() => {
                refreshBtn.innerHTML = 'ğŸ”„ åˆ·æ–°æ–°é—»';
                refreshBtn.disabled = false;
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            initializeCharts();
            fetchAndUpdateData();
            updatePlayerDistribution();
            updatePlanetHealthTrend();
            updateOrdersData();
            updateRegionChartsData();
    
            // åˆå§‹åŒ–æ–°é—»ç»Ÿè®¡
            updateNewsStats();
            
            // æ¯5åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ•°æ®
            setInterval(() => {
                fetchAndUpdateData();
                updateOrdersData();
                updateRegionChartsData();
        
                // å¦‚æœå½“å‰åœ¨æ–°é—»æ ‡ç­¾é¡µï¼Œåˆ·æ–°æ–°é—»ç»Ÿè®¡
                if (document.getElementById('news').classList.contains('active')) {
                    updateNewsStats();
                }
                
                if (typeof currentSelectedPlanet !== 'undefined' && currentSelectedPlanet != null) {
                    displayPlanetDetails(currentSelectedPlanet);
                }
                if (typeof currentSelectedPlanet !== 'undefined' && typeof currentSelectedRegion !== 'undefined' && currentSelectedPlanet != null && currentSelectedRegion != null) {
                    loadRegionHealthChart(currentSelectedPlanet, currentSelectedRegion);
                }
                if (typeof currentSelectedOrder !== 'undefined' && currentSelectedOrder != null) {
                    const timeRange = document.getElementById('ordersTimeRange')?.value || 48;
                    displayOrderDetails(currentSelectedOrder, timeRange);
                }
            }, 300000);
        });
    </script>
</body>
</html>